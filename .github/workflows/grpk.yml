name: "GRPK: publish basemap"
run-name: "GRPK: publish basemap (${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'development' }})"

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: read
  packages: write

jobs:
  publish-grpk-basemap:
    name: Publish GRPK basemap
    uses: ./.github/workflows/reusable-workflow-publish-grpk-basemap.yml
    if: startsWith(github.ref, 'refs/tags/')
    concurrency: grpk-basemap-publish
    with:
      docker-image-tag: stable
      archive-version: ${{ github.ref_name }}
      s3-endpoint: ${{ vars.S3_BIIP_ENDPOINT }}
      tile-server-url: https://gis.biip.lt/basemap/grpk
    secrets:
      S3_ACCESS_KEY_ID: ${{ secrets.S3_BIIP_ACCESS_KEY_ID }}
      S3_SECRET_ACCESS_KEY: ${{ secrets.S3_BIIP_SECRET_ACCESS_KEY }}

  publish-grpk-basemap-development:
    name: Publish development GRPK basemap
    uses: ./.github/workflows/reusable-workflow-publish-grpk-basemap.yml
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    concurrency:
      group: grpk-basemap-publish-development
      cancel-in-progress: true
    with:
      docker-image-tag: development
      archive-version: 0.0.0
      s3-endpoint: ${{ vars.S3_DEVELOPMENT_BIIP_ENDPOINT}}
      tile-server-url: https://dev-gis.biip.lt/basemap/grpk
    secrets:
      S3_ACCESS_KEY_ID: ${{ secrets.S3_DEVELOPMENT_BIIP_ACCESS_KEY_ID }}
      S3_SECRET_ACCESS_KEY: ${{ secrets.S3_DEVELOPMENT_BIIP_SECRET_ACCESS_KEY }}
